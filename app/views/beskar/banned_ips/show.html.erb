<% content_for :page_title, "Banned IP: #{@banned_ip.ip_address}" %>

<% content_for :header_actions do %>
  <%= link_to "← Back to Banned IPs", banned_ips_path, class: "btn btn-secondary" %>
  <%= link_to "Edit", edit_banned_ip_path(@banned_ip), class: "btn btn-secondary" %>
  <%= link_to "Unban", banned_ip_path(@banned_ip),
      data: {
        "turbo-method": "delete",
        "turbo-confirm": "Are you sure you want to unban #{@banned_ip.ip_address}?"
      },
      class: "btn btn-danger" %>
<% end %>

<!-- Ban Overview -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">Ban Details</h3>
    <div class="card-subtitle">IP Address: <%= @banned_ip.ip_address %></div>
  </div>
  <div class="card-body">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
      <!-- IP Address -->
      <div>
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-bottom: 0.5rem;">
          IP Address
        </div>
        <div style="font-family: monospace; font-size: 18px; font-weight: 500; color: #1A1F36;">
          <%= @banned_ip.ip_address %>
        </div>
        <% if @banned_ip.metadata&.dig("geolocation") %>
          <div style="font-size: 13px; color: #697386; margin-top: 0.25rem;">
            <%= [@banned_ip.metadata.dig("geolocation", "city"),
                 @banned_ip.metadata.dig("geolocation", "region"),
                 @banned_ip.metadata.dig("geolocation", "country")].compact.join(", ") %>
          </div>
        <% end %>
      </div>

      <!-- Status -->
      <div>
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-bottom: 0.5rem;">
          Status
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <% if @banned_ip.permanent? %>
            <span class="badge badge-critical">Permanent Ban</span>
          <% elsif @banned_ip.active? %>
            <span class="badge badge-danger">Active</span>
          <% else %>
            <span class="badge badge-neutral">Expired</span>
          <% end %>
        </div>
        <% if @banned_ip.active? && !@banned_ip.permanent? && @banned_ip.expires_at %>
          <div style="font-size: 13px; color: #697386; margin-top: 0.5rem;">
            Expires in <%= distance_of_time_in_words(Time.current, @banned_ip.expires_at) %>
          </div>
        <% end %>
      </div>

      <!-- Reason -->
      <div>
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-bottom: 0.5rem;">
          Ban Reason
        </div>
        <div style="font-size: 14px; color: #1A1F36;">
          <%= @banned_ip.reason.humanize %>
        </div>
        <% if @banned_ip.details.present? %>
          <div style="font-size: 13px; color: #697386; margin-top: 0.25rem;">
            <%= @banned_ip.details %>
          </div>
        <% end %>
      </div>

      <!-- Banned At -->
      <div>
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-bottom: 0.5rem;">
          Banned At
        </div>
        <div style="font-size: 14px; color: #1A1F36;">
          <%= @banned_ip.banned_at.strftime("%B %d, %Y") %>
        </div>
        <div style="font-size: 13px; color: #697386; margin-top: 0.25rem;">
          <%= @banned_ip.banned_at.strftime("%H:%M:%S %Z") %>
          (<%= time_ago_in_words(@banned_ip.banned_at) %> ago)
        </div>
      </div>

      <!-- Expires At -->
      <div>
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-bottom: 0.5rem;">
          Expires At
        </div>
        <% if @banned_ip.permanent? %>
          <div style="font-size: 14px; color: #D32F2F; font-weight: 500;">
            Never (Permanent Ban)
          </div>
        <% elsif @banned_ip.expires_at %>
          <div style="font-size: 14px; color: #1A1F36;">
            <%= @banned_ip.expires_at.strftime("%B %d, %Y") %>
          </div>
          <div style="font-size: 13px; color: #697386; margin-top: 0.25rem;">
            <%= @banned_ip.expires_at.strftime("%H:%M:%S %Z") %>
          </div>
        <% else %>
          <div style="color: #C1C7D0;">Not set</div>
        <% end %>
      </div>

      <!-- Violation Count -->
      <div>
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-bottom: 0.5rem;">
          Violation Count
        </div>
        <div style="font-size: 24px; font-weight: 600; color: <%= @banned_ip.violation_count > 3 ? '#D32F2F' : '#1A1F36' %>;">
          <%= @banned_ip.violation_count %>
        </div>
        <% if @banned_ip.violation_count > 0 %>
          <div style="font-size: 13px; color: #697386; margin-top: 0.25rem;">
            <%= @banned_ip.violation_count == 1 ? 'violation' : 'violations' %> recorded
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Statistics -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">IP Statistics</h3>
    <div class="card-subtitle">Activity summary for <%= @banned_ip.ip_address %></div>
  </div>
  <div class="card-body">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
      <div style="text-align: center; padding: 1rem; background: #FAFBFC; border-radius: 6px;">
        <div style="font-size: 24px; font-weight: 600; color: #1A1F36;">
          <%= @stats[:total_events] %>
        </div>
        <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-top: 0.25rem;">
          Total Events
        </div>
      </div>

      <div style="text-align: center; padding: 1rem; background: #FAFBFC; border-radius: 6px;">
        <div style="font-size: 24px; font-weight: 600; color: <%= @stats[:avg_risk_score] > 70 ? '#E91E63' : '#1A1F36' %>;">
          <%= @stats[:avg_risk_score] %>
        </div>
        <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-top: 0.25rem;">
          Avg Risk Score
        </div>
      </div>

      <div style="text-align: center; padding: 1rem; background: #FAFBFC; border-radius: 6px;">
        <div style="font-size: 24px; font-weight: 600; color: <%= @stats[:max_risk_score] > 85 ? '#D32F2F' : '#1A1F36' %>;">
          <%= @stats[:max_risk_score] %>
        </div>
        <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-top: 0.25rem;">
          Max Risk Score
        </div>
      </div>

      <% if @stats[:first_seen] %>
        <div style="text-align: center; padding: 1rem; background: #FAFBFC; border-radius: 6px;">
          <div style="font-size: 13px; font-weight: 500; color: #1A1F36;">
            <%= @stats[:first_seen].strftime("%Y-%m-%d") %>
          </div>
          <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-top: 0.25rem;">
            First Seen
          </div>
        </div>
      <% end %>

      <% if @stats[:last_seen] %>
        <div style="text-align: center; padding: 1rem; background: #FAFBFC; border-radius: 6px;">
          <div style="font-size: 13px; font-weight: 500; color: #1A1F36;">
            <%= @stats[:last_seen].strftime("%Y-%m-%d") %>
          </div>
          <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; color: #697386; margin-top: 0.25rem;">
            Last Seen
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Metadata -->
<% if @banned_ip.metadata.present? && @banned_ip.metadata.any? %>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Additional Metadata</h3>
    </div>
    <div class="card-body">
      <pre style="font-family: monospace; font-size: 12px; background: #F4F5F7; padding: 1rem; border-radius: 6px; overflow-x: auto;"><%= JSON.pretty_generate(@banned_ip.metadata) %></pre>
    </div>
  </div>
<% end %>

<!-- Related Security Events -->
<% if @related_events.any? %>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Related Security Events</h3>
      <div class="card-subtitle"><%= @related_events.count %> events from this IP address</div>
    </div>
    <div class="card-body" style="padding: 0;">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Event Type</th>
              <th>User</th>
              <th>Risk Score</th>
              <th>Details</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @related_events.each do |event| %>
              <tr>
                <td>
                  <div style="font-size: 13px;">
                    <%= event.created_at.strftime("%Y-%m-%d") %>
                  </div>
                  <div style="font-size: 11px; color: #697386;">
                    <%= event.created_at.strftime("%H:%M:%S") %>
                  </div>
                </td>
                <td>
                  <div style="font-size: 13px;">
                    <%= format_event_type(event.event_type) %>
                  </div>
                  <div style="font-size: 11px; color: #697386;">
                    <%= event.event_type %>
                  </div>
                </td>
                <td>
                  <% if event.user %>
                    <div style="font-size: 13px;">
                      <%= event.user.try(:email) || "User ##{event.user_id}" %>
                    </div>
                  <% elsif event.attempted_email %>
                    <div style="font-size: 13px; color: #697386;">
                      <%= event.attempted_email %>
                    </div>
                  <% else %>
                    <span style="color: #C1C7D0;">-</span>
                  <% end %>
                </td>
                <td>
                  <span class="badge badge-<%= risk_level_class(event.risk_score) %>">
                    <%= event.risk_score %>
                  </span>
                </td>
                <td>
                  <div style="font-size: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <%= event.details || event.metadata&.dig("message") || "-" %>
                  </div>
                </td>
                <td>
                  <%= link_to "View", security_event_path(event), class: "btn btn-sm btn-secondary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <% if @related_events.count >= 20 %>
        <div style="padding: 1rem; text-align: center; border-top: 1px solid #E3E8EE;">
          <%= link_to "View All Events from this IP →", security_events_path(ip_address: @banned_ip.ip_address),
              style: "color: var(--primary); text-decoration: none; font-size: 13px; font-weight: 500;" %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Actions -->
<div style="display: flex; gap: 1rem; margin-top: 2rem;">
  <%= link_to "← Back to Banned IPs", banned_ips_path, class: "btn btn-secondary" %>
  <%= link_to "Edit Ban", edit_banned_ip_path(@banned_ip), class: "btn btn-secondary" %>

  <% if @banned_ip.active? && !@banned_ip.permanent? %>
    <div style="display: flex; gap: 0.5rem; margin-left: auto;">
      <%= form_with url: extend_banned_ip_path(@banned_ip), method: :post, local: true, style: "display: flex; gap: 0.5rem;" do |f| %>
        <%= select_tag :duration,
            options_for_select([
              ['Extend 1 hour', '1h'],
              ['Extend 6 hours', '6h'],
              ['Extend 24 hours', '24h'],
              ['Extend 7 days', '7d'],
              ['Extend 30 days', '30d'],
              ['Make Permanent', 'permanent']
            ]),
            style: "padding: 0.5rem 0.75rem; font-size: 14px;" %>
        <%= submit_tag "Extend Ban", class: "btn btn-warning" %>
      <% end %>
    </div>
  <% end %>

  <%= link_to "Unban IP", banned_ip_path(@banned_ip),
      data: {
        "turbo-method": "delete",
        "turbo-confirm": "Are you sure you want to unban #{@banned_ip.ip_address}?"
      },
      class: "btn btn-danger",
      style: "margin-left: #{ @banned_ip.active? && !@banned_ip.permanent? ? '0' : 'auto' };" %>
</div>
